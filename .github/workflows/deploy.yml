name: Deploy Laravel App to Server

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key.pem
        chmod 600 ~/.ssh/deploy_key.pem

    - name: Add known hosts
      run: |
        ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

    - name: Deploy Code via SSH
      run: |
        ssh -i ~/.ssh/deploy_key.pem -T -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} bash << 'EOSSH'
          echo "Navigating to the Laradock directory"
          cd /var/www/pincap/laradock || { echo "Failed to cd into /var/www/pincap/laradock"; exit 1; }

          echo "Bringing up Docker containers"
          docker-compose up -d || { echo "Docker-compose up failed"; exit 1; }

          echo "Running git pull"
          docker-compose exec -T workspace bash -c 'git pull origin master' || { echo "Git pull failed"; exit 1; }

          echo "Running migrations"
          docker-compose exec -T workspace bash -c 'php artisan migrate --force' || { echo "Migrate failed"; exit 1; }

          echo "Optimizing the application"
          docker-compose exec -T workspace bash -c 'php artisan optimize' || { echo "Optimize failed"; exit 1; }
        EOSSH
